#!/bin/env python
# Requires: ffmpeg sox librosa

import os
import random
import subprocess
import time
import configparser
import logging

def load_settings():
    config = configparser.ConfigParser()
    config.read('config.ini')
    settings = config['Settings']
    return {
        'music_folder': settings['music_folder'],
        'playlist_file': settings['playlist_file'],
        'shoutcast_server': settings['shoutcast_server'],
        'port': settings['port'],
        'password': settings['password'],
        'stream_id': settings['stream_id'],
        'bitrate': settings['bitrate'],
        'normalize_audio': settings.getboolean('normalize_audio'),
        'ice_name': settings['ice_name'],
        'ice_description': settings['ice_description'],
        'ice_genre': settings['ice_genre'],
        'stingers_folder': settings['stingers_folder'],
        'dynamic_crossfade': settings.getboolean('dynamic_crossfade'),
        'max_crossfade_duration': int(settings['max_crossfade_duration']),
        'min_crossfade_duration': int(settings['min_crossfade_duration']),
        'log_file': settings['log_file']
    }

def setup_logging(log_file):
    logging.basicConfig(filename=log_file, level=logging.ERROR, format='%(asctime)s - %(levelname)s - %(message)s')

def generate_playlist(music_folder, playlist_file):
    music_files = [file for file in os.listdir(music_folder) if file.endswith((".mp3", ".wav", ".flac", ".aac", ".ogg", ".m4a", ".wma", ".aiff", ".alac"))]
    random.shuffle(music_files)
    with open(playlist_file, "w") as f:
        for file in music_files:
            f.write(f"{music_folder}{file}\n")

def crossfade_tracks(track1, track2, crossfade_duration):
    temp_file = "crossfade_temp.mp3"
    command = f"sox {track1} {track2} {temp_file} -C 192 fade t 0 {crossfade_duration} {crossfade_duration} remix -"
    subprocess.run(command, shell=True)
    return temp_file

def normalize_audio(track):
    temp_file = "normalized_temp.wav"
    command = f"sox {track} {temp_file} loudnorm"
    subprocess.run(command, shell=True)
    return temp_file

def main():
    settings = load_settings()
    music_folder = settings['music_folder']
    playlist_file = settings['playlist_file']
    shoutcast_server = settings['shoutcast_server']
    port = settings['port']
    password = settings['password']
    stream_id = settings['stream_id']
    bitrate = settings['bitrate']
    normalize_audio = settings['normalize_audio']
    ice_name = settings['ice_name']
    ice_description = settings['ice_description']
    ice_genre = settings['ice_genre']
    stingers_folder = settings['stingers_folder']
    dynamic_crossfade = settings['dynamic_crossfade']
    max_crossfade_duration = settings['max_crossfade_duration']
    min_crossfade_duration = settings['min_crossfade_duration']
    log_file = settings['log_file']

    # Setup logging
    setup_logging(log_file)

    while True:
        # Check for missing or deleted music or stinger files
        if not os.path.exists(music_folder) or not os.path.exists(stingers_folder):
            logging.error("Music or stinger folder does not exist.")
            generate_playlist(music_folder, playlist_file)
        
        # Generate playlist
        generate_playlist(music_folder, playlist_file)
        
        with open(playlist_file, "r") as f:
            previous_track = None
            for line in f:
                line = line.strip()
                if line:
                    file_name = line
                    if not os.path.exists(file_name):
                        logging.error(f"File does not exist: {file_name}")
                        continue

                    file_base = os.path.basename(file_name)
                    artist, song = file_base.split(" - ") if " - " in file_base else ("Unknown Artist", file_base)
                    command = f"ffmpeg -i $input -f mp3 -acodec libmp3lame -ab {bitrate} -content_type audio/mpeg -re \
-ice_name '{ice_name}' -ice_description '{ice_description}' -ice_genre '{ice_genre}' -ice_public 1 \
-content_type audio/mpeg -content_type 'audio/mpeg' -ice_private 0 \
-ice_bitrate {bitrate} -content_type 'audio/mpeg' -ac 2 -reconnect 1 \
-reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 2 \
-reconnect_on_network_error 1 -reconnect_on_http_error 1 \
-headers 'User-Agent: FMSc/1.0' -f mp3 http://{shoutcast_server}:{port}/{password}/{stream_id}"
                    if normalize_audio:
                        normalized_file = normalize_audio(file_name)
                        file_name = normalized_file
                    if previous_track and dynamic_crossfade:
                        crossfade_duration = max(min(int(max_crossfade_duration), int(min_crossfade_duration) + int(previous_track_duration) - int(crossfade_position)), int(min_crossfade_duration))
                        crossfade_file = crossfade_tracks(previous_track, file_name, crossfade_duration)
                        command = command.replace("$input", f'"{crossfade_file}"')
                    else:
                        command = command.replace("$input", f'"{file_name}"')
                    subprocess.Popen(command, shell=True).wait()
                    if previous_track:
                        os.remove(crossfade_file)
                    if normalize_audio:
                        os.remove(normalized_file)
                    previous_track = file_name

        # Sleep for a day before generating the playlist again
        time.sleep(24 * 60 * 60)

if __name__ == "__main__":
    main()
